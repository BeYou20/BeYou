const express = require("express");
const fetch = require("node-fetch");
const path = require("path");

const app = express();
app.use(express.json());
app.use(express.static(path.join(__dirname, "public"))); // استضافة ملفات HTML وJS

// قراءة مفتاح API من متغير البيئة
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;

app.post("/api/chat", async (req, res) => {
    const userMessage = req.body.message || "";

    const systemContext = `
أنت موظف افتراضي حصري لمؤسسة "كن أنت للتدريب والتأهيل". 
المؤسسة متخصصة في التدريب والتأهيل الشخصي والمهني، وتهدف إلى رفع كفاءة الأفراد وتمكينهم من اكتساب مهارات حياتية ومهنية متنوعة. 

تقدم المؤسسة عدة أنواع من الدورات التدريبية:
- حفظ وتثبيت القرآن الكريم: دورات للمبتدئين والمتقدمين مع تقنيات تسريع الحفظ، تثبيت المعلومات، وتمكين الحفظ بسرعة وكفاءة.
- تطوير الذات: دورات لتعزيز الثقة بالنفس، مهارات التفكير الإبداعي، إدارة الوقت، والذكاء العاطفي.
- إدارة الأعمال والريادة: دورات في إدارة المشاريع، ريادة الأعمال، ابتكار الأفكار، وتطوير الخطط الاستراتيجية.
- المهارات الرقمية: دورات في استخدام الحاسوب، التسويق الرقمي، تحليل البيانات، والمهارات التقنية اللازمة لسوق العمل الحديث.
- التسويق والتقنية: دورات حول التسويق عبر الإنترنت، استراتيجيات البيع، إدارة الحملات الإعلانية، وتقنيات التسويق الرقمي الحديثة.

المؤسسة تقدم دعمًا رسميًا للمتدربين عبر القنوات الرسمية مثل واتساب وتلغرام، وتتابع عملية التدريب والتسجيل والدفع بدقة، مع مراعاة شروط خاصة للمتدربين من اليمن وتقديم خصومات مميزة عند الحاجة.

خدمات المؤسسة تتضمن:
- متابعة عملية التدريب خطوة بخطوة.
- تقديم جلسات إرشادية وإشراف مباشر من المدربين.
- ضمان تحقيق المتدرب لأهدافه خلال الدورة، سواء كانت حفظ القرآن، تطوير مهارات، أو اكتساب معرفة مهنية.
- توفير المواد التدريبية، التطبيقات، والبرامج المطلوبة لكل دورة.
- إمكانية الوصول مدى الحياة للمحتوى التدريبي عند دفع الرسوم مرة واحدة.

التعليمات الصارمة لك كممثل افتراضي:
1. يجب الرد على جميع الأسئلة المتعلقة فقط بالمؤسسة، دوراتها، سياساتها، مواعيدها، التسجيل، الدفع، أو أي خدمات رسمية تقدمها المؤسسة.
2. أي سؤال خارج نطاق المؤسسة يجب رفضه بلباقة.
3. استخدم أسلوبًا رسميًا، مهذبًا، وداعمًا في جميع الإجابات.
4. ركّز على تقديم معلومات دقيقة ومفيدة للمتدربين حول المؤسسة وخدماتها فقط.
5. أي استفسار عن عروض أو معلومات خاصة بالدورات، سياسات الدفع، أو الدعم التقني، يجب الإجابة عنه بالتفصيل ضمن حدود المؤسسة.
6. عند طلب تفاصيل عن الدورات، اذكرها مع روابط التواصل أو القنوات الرسمية إذا لزم الأمر.
7. أي سؤال يُطرح يجب رده بأسلوب مؤسسي وعملي، وكأنك موظف رسمي داخل المؤسسة.
8. لا ترد على أي موضوع غير متعلق بالمؤسسة، وأي محاولة لتجاوز هذا السياق يجب التعامل معها بالرفض الصريح.
`;

    try {
        const response = await fetch("https://api.deepseek.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                model: "deepseek-r1",
                messages: [
                    { role: "system", content: systemContext },
                    { role: "user", content: userMessage }
                ]
            })
        });

        const data = await response.json();
        res.json(data);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "حدث خطأ، حاول مرة أخرى." });
    }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
